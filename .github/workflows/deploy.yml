name: Deploy Spring Boot App with Gradle and Docker

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰ë¨

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # GitHubì—ì„œ ì œê³µí•˜ëŠ” Ubuntu ì„œë²„ì—ì„œ ì‹¤í–‰

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3  # ì½”ë“œ ê°€ì ¸ì˜¤ê¸°

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission to Gradle
        run: chmod +x gradlew  # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

      - name: Build with Gradle (Without Tests)
        run: ./gradlew clean build -x test  # í…ŒìŠ¤íŠ¸ë¥¼ ì œì™¸í•˜ê³  ë¹Œë“œ

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2  # Docker Buildx ì„¤ì •

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°
          password: ${{ secrets.DOCKER_PASSWORD }}  # GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°

      - name: Debug: Check Docker Info
        run: |
          docker info
          docker version
          docker images
          echo "ğŸ”¹ Docker ì‹¤í–‰ í™˜ê²½ í™•ì¸ ì™„ë£Œ"

      - name: Build and Push Docker Image
        run: |
          echo "ğŸ”¹ Generating IMAGE_TAG..."
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)  # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG"
          echo "ğŸ”¹ IMAGE_TAG í™•ì¸: $IMAGE_TAG"
          echo "ğŸ”¹ IMAGE_NAME í™•ì¸: $IMAGE_NAME"
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $IMAGE_NAME . || { echo "âŒ Docker build ì‹¤íŒ¨"; exit 1; }
          # ìµœì‹  íƒœê·¸ ì ìš©
          docker tag $IMAGE_NAME ${{ secrets.DOCKER_USERNAME }}/babpat-backend:latest
          # Docker Hub í‘¸ì‹œ
          docker push $IMAGE_NAME || { echo "âŒ Docker push ì‹¤íŒ¨"; exit 1; }
          docker push ${{ secrets.DOCKER_USERNAME }}/babpat-backend:latest || { echo "âŒ Docker push ì‹¤íŒ¨"; exit 1; }

      - name: Save SSH Key (PEM)
        run: |
          echo "ğŸ”¹ Decoding SSH Key..."
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem || { echo "âŒ SSH í‚¤ ë³µí˜¸í™” ì‹¤íŒ¨"; exit 1; }
          chmod 600 key.pem  # íŒŒì¼ ê¶Œí•œ ì„¤ì •

      - name: Deploy to EC2 (Zero Downtime)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ğŸ”¹ EC2 ì ‘ì† ì„±ê³µ. Docker ì»¨í…Œì´ë„ˆ ë°°í¬ ì‹œì‘..."

            echo "ğŸ”¹ í™˜ê²½ ë³€ìˆ˜ í™•ì¸..."
            echo "DB_URL=${{ secrets.DB_URL }}"
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}"
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}"

            echo "ğŸ”¹ ìµœì‹  Docker ì´ë¯¸ì§€ í™•ì¸..."
            IMAGE_TAG=$(docker images | grep '${{ secrets.DOCKER_USERNAME }}/babpat-backend' | awk '{print $2}' | head -n 1)
            echo "IMAGE_TAG: $IMAGE_TAG"
            if [ -z "$IMAGE_TAG" ]; then
              echo "âŒ Docker ì´ë¯¸ì§€ íƒœê·¸ê°€ ë¹„ì–´ ìˆìŒ!"
              exit 1
            fi

            echo "ğŸ”¹ ìµœì‹  Docker ì´ë¯¸ì§€ Pull..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG || { echo "âŒ Docker Pull ì‹¤íŒ¨"; exit 1; }

            echo "ğŸ”¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            docker stop babpat-backend || echo "âš  ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ì—†ìŒ"
            docker rm babpat-backend || echo "âš  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ ë¶ˆí•„ìš”"

            echo "ğŸ”¹ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
            docker run -d --name babpat-backend -p 8080:8080 \
              -e DB_URL="${{ secrets.DB_URL }}" \
              -e DB_USERNAME="${{ secrets.DB_USERNAME }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG || { echo "âŒ Docker ì‹¤í–‰ ì‹¤íŒ¨"; exit 1; }

            echo "ğŸ”¹ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸:"
            docker ps -a
          EOF
