name: Deploy Spring Boot App with Gradle and Docker

on:
  push:
    branches:
      - main
      - develop
      - feat/cicd-dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'main' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3  # ì½”ë“œ ê°€ì ¸ì˜¤ê¸°

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission to Gradle
        run: chmod +x gradlew  # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

      - name: Build with Gradle (Without Tests)
        run: ./gradlew clean build -x test  # í…ŒìŠ¤íŠ¸ ì œì™¸ ë¹Œë“œ

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2  # Docker Buildx ì„¤ì •

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set Image & Container Name
        run: |
          echo "ğŸ”¹ Setting IMAGE_NAME with latest tag..."
          
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          if [ "$BRANCH_NAME" == "main" ]; then
            IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/babpat-backend:latest"
            SPRING_PROFILE="prod"
          else
            IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/dev-babpat-backend:latest"
            SPRING_PROFILE="dev"
          fi

          CONTAINER_NAME="babpat-backend"

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "CONTAINER_NAME=${CONTAINER_NAME}" >> $GITHUB_ENV
          echo "SPRING_PROFILE=${SPRING_PROFILE}" >> $GITHUB_ENV

          echo "ğŸ”¹ IMAGE_NAME í™•ì¸: ${IMAGE_NAME}"
          echo "ğŸ”¹ CONTAINER_NAME í™•ì¸: ${CONTAINER_NAME}"
          echo "ğŸ”¹ SPRING_PROFILE í™•ì¸: ${SPRING_PROFILE}"

      - name: Build and Push Docker Image
        run: |
          echo "ğŸ”¹ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t "$IMAGE_NAME" . || { echo "âŒ Docker build ì‹¤íŒ¨"; exit 1; }
          
          echo "ğŸ”¹ Docker Hub í‘¸ì‹œ..."
          docker push "$IMAGE_NAME" || { echo "âŒ Docker push ì‹¤íŒ¨"; exit 1; }

      - name: Save SSH Key (PEM)
        run: |
          echo "ğŸ”¹ Saving SSH Key..."
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem  # íŒŒì¼ ê¶Œí•œ ì„¤ì •

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} "bash -s" <<EOF
            echo "ğŸ”¹ EC2 ì ‘ì† ì„±ê³µ. Docker ì»¨í…Œì´ë„ˆ ë°°í¬ ì‹œì‘..."
            echo "ğŸ”¹ ì‚¬ìš© ì¤‘ì¸ Docker ì´ë¯¸ì§€: ${IMAGE_NAME}"
            echo "ğŸ”¹ ì ìš©í•  Spring í”„ë¡œí•„: ${SPRING_PROFILE}"

            echo "ğŸ”¹ Docker Hub ë¡œê·¸ì¸"
            docker login -u '${{ secrets.DOCKER_USERNAME }}' -p '${{ secrets.DOCKER_PASSWORD }}' || { echo "âŒ Docker Hub ë¡œê·¸ì¸ ì‹¤íŒ¨"; exit 1; }
            
            echo "ğŸ”¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            if [ "\$(docker ps -q -f name=${CONTAINER_NAME})" ]; then
              docker stop ${CONTAINER_NAME}
              docker rm ${CONTAINER_NAME}
            else
              echo "âš  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
            fi

            echo "ğŸ”¹ ìµœì‹  Docker ì´ë¯¸ì§€ Pull..."
            docker pull "${IMAGE_NAME}" || { echo "âŒ Docker Pull ì‹¤íŒ¨"; exit 1; }

            echo "ğŸ”¹ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker run -d --name ${CONTAINER_NAME} -p 8080:8080 \
              --network host \
              -e SPRING_PROFILES_ACTIVE='${SPRING_PROFILE}' \
              -e SPRING_DATASOURCE_URL='${{ secrets.DB_URL }}' \
              -e SPRING_DATASOURCE_USERNAME='${{ secrets.DB_USERNAME }}' \
              -e SPRING_DATASOURCE_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              -e SPRING_DATASOURCE_DRIVER_CLASS_NAME='com.mysql.cj.jdbc.Driver' \
              -e SPRING_DATA_REDIS_HOST='${{ secrets.REDIS_HOST }}' \
              -e SPRING_DATA_REDIS_PORT='${{ secrets.REDIS_PORT }}' \
              -e SPRING_DATA_REDIS_REPOSITORIES_ENABLED='false' \
              -e SPRING_JPA_HIBERNATE_DDL_AUTO='create' \
              -e SPRING_JPA_SHOW_SQL='true' \
              -e SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL='true' \
              -e SERVER_SERVLET_SESSION_COOKIE_DOMAIN='${{ secrets.SERVER_COOKIE_DOMAIN }}' \
              -e JWT_SECRET='${{ secrets.JWT_SECRET }}' \
              -e JWT_EXPIRATION_TIME_ACCESS_TOKEN='${{ secrets.JWT_EXPIRATION_TIME_ACCESS_TOKEN }}' \
              -e JWT_EXPIRATION_TIME_REFRESH_TOKEN='${{ secrets.JWT_EXPIRATION_TIME_REFRESH_TOKEN }}' \
              --restart unless-stopped \
              "${IMAGE_NAME}"
          EOF
