name: Deploy Spring Boot App with Gradle and Docker

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰ë¨

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission to Gradle
        run: chmod +x gradlew

      - name: Build with Gradle (Without Tests)
        run: ./gradlew clean build -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)
          docker build -t ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG .
          docker tag ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG ${{ secrets.DOCKER_USERNAME }}/babpat-backend:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG
          docker push ${{ secrets.DOCKER_USERNAME }}/babpat-backend:latest

      - name: Save SSH Key (PEM)
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem
          chmod 600 key.pem

      - name: Deploy to EC2 (Zero Downtime)
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ðŸ”¹ EC2 ì ‘ì† ì„±ê³µ. Docker ì»¨í…Œì´ë„ˆ ë°°í¬ ì‹œìž‘..."
          
            # ìµœì‹  Docker ì´ë¯¸ì§€ Pull (ìƒˆë¡œìš´ íƒœê·¸ ì‚¬ìš©)
            IMAGE_TAG=$(docker images | grep '${{ secrets.DOCKER_USERNAME }}/babpat-backend' | awk '{print $2}' | head -n 1)
            echo "ðŸ”¹ ìµœì‹  Docker ì´ë¯¸ì§€: $IMAGE_TAG"
            docker pull ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨ ì—†ì´)
            echo "ðŸ”¹ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰..."
            docker run -d --name babpat-backend-new -p 8080:8080 \
              -e DB_URL=${{ secrets.DB_URL }} \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/babpat-backend:$IMAGE_TAG

            # ìƒˆ ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "ðŸ”¹ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í™•ì¸ ì¤‘..."
            sleep 10
            NEW_CONTAINER_STATUS=$(docker inspect -f '{{.State.Health.Status}}' babpat-backend-new || echo "healthy")
            if [ "$NEW_CONTAINER_STATUS" != "healthy" ]; then
              echo "âŒ ìƒˆ ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ! ë¡¤ë°± ì¤‘..."
              docker stop babpat-backend-new
              docker rm babpat-backend-new
              exit 1
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ì§€ & ì‚­ì œ
            echo "ðŸ”¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ..."
            docker stop babpat-backend || true
            docker rm babpat-backend || true

            # ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ê¸°ì¡´ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
            echo "ðŸ”¹ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¡œ êµì²´..."
            docker rename babpat-backend-new babpat-backend

            # ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            echo "ðŸ”¹ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ëª©ë¡:"
            docker ps -a
          EOF
